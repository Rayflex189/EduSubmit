{% extends "base.html" %}
{% load static %}

{% block title %}Grade Assignment - EduManage Pro{% endblock %}

{% block page_header %}
<div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Grade Assignment</h1>
        <p class="mt-2 text-gray-600">
            <i class="fas fa-graduation-cap mr-2"></i>
            Provide feedback and assessment for student submission
        </p>
    </div>
    
    <div class="flex flex-wrap gap-3">
        <a href="{% url 'lecturer_dashboard' %}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Dashboard
        </a>
        {% if assignment.graded_by %}
        <span class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg text-sm font-medium">
            <i class="fas fa-check-circle mr-2"></i>
            Previously Graded
        </span>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Student & Assignment Info -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Assignment Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center mb-2">
                                <span class="text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full mr-3">
                                    {{ assignment.course.code }}
                                </span>
                                <span class="text-sm text-gray-500">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    {{ assignment.date_uploaded|date:"M d, Y" }}
                                </span>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900 mb-2">{{ assignment.title }}</h2>
                            {% if assignment.description %}
                            <p class="text-gray-600 mb-4">{{ assignment.description }}</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                                {% if assignment.status == 'graded' %}bg-green-100 text-green-800
                                {% elif assignment.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif assignment.status == 'under_review' %}bg-blue-100 text-blue-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                <i class="fas {% if assignment.status == 'graded' %}fa-check
                                    {% elif assignment.status == 'pending' %}fa-clock
                                    {% elif assignment.status == 'under_review' %}fa-eye
                                    {% else %}fa-redo{% endif %} mr-1"></i>
                                {{ assignment.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- File Preview -->
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-file-alt mr-2 text-blue-500"></i>
                        Submitted File
                    </h3>
                    
                    {% if assignment.file %}
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="h-12 w-12 rounded-lg bg-blue-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-file-pdf text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">Assignment Submission</p>
                                    <p class="text-sm text-gray-500">
                                        Uploaded: {{ assignment.date_uploaded|timesince }} ago
                                    </p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <a href="{{ assignment.file.url }}" target="_blank"
                                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white gradient-primary hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-eye mr-2"></i>
                                    View
                                </a>
                                <a href="{{ assignment.file.url }}" download
                                   class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-download mr-2"></i>
                                    Download
                                </a>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                        <i class="fas fa-file-exclamation text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">No file uploaded for this assignment</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Student Information -->
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-user-graduate mr-2 text-green-500"></i>
                        Student Information
                    </h3>
                    
                    <div class="bg-gray-50 rounded-lg p-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Student Name</p>
                                <p class="text-lg font-semibold text-gray-900">{{ assignment.student.user.full_name }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Matric Number</p>
                                <p class="font-mono text-lg font-semibold text-gray-900">{{ assignment.student.matric_number }}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Department</p>
                                <p class="text-gray-900">{{ assignment.student.department.name }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Level</p>
                                <p class="text-gray-900">{{ assignment.student.level.name }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Faculty</p>
                                <p class="text-gray-900">{{ assignment.student.faculty.name }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Previous Feedback (if exists) -->
            {% if assignment.feedback %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-comment-dots text-yellow-400 text-xl"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-lg font-medium text-yellow-800 mb-2">Previous Feedback</h3>
                        <div class="text-yellow-700">
                            {{ assignment.feedback }}
                        </div>
                        {% if assignment.graded_by %}
                        <div class="mt-3 text-sm text-yellow-600">
                            <i class="fas fa-user-tie mr-1"></i>
                            Graded by {{ assignment.graded_by.user.full_name }}
                            {% if assignment.graded_date %}
                            on {{ assignment.graded_date|date:"M d, Y" }}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Column: Grading Form -->
        <div class="space-y-6">
            <!-- Current Grade Status -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-star mr-2 text-yellow-500"></i>
                    Current Assessment
                </h3>
                
                <div class="space-y-4">
                    {% if assignment.grade %}
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-4xl font-bold text-green-600 mb-2">{{ assignment.grade }}</div>
                        {% if assignment.score %}
                        <div class="text-2xl font-semibold text-gray-700">{{ assignment.score }}/100</div>
                        {% endif %}
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-check-circle mr-1"></i>
                            Graded on {{ assignment.graded_date|date:"M d, Y"|default:"previous date" }}
                        </p>
                    </div>
                    {% else %}
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <i class="fas fa-clock text-yellow-500 text-3xl mb-3"></i>
                        <p class="text-lg font-medium text-yellow-800">Pending Assessment</p>
                        <p class="text-sm text-yellow-600 mt-1">Awaiting your evaluation</p>
                    </div>
                    {% endif %}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-600 mb-1">Submission Date</p>
                            <p class="font-semibold text-gray-900">{{ assignment.date_uploaded|date:"M d, Y" }}</p>
                        </div>
                        {% if assignment.deadline %}
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-600 mb-1">Deadline</p>
                            <p class="font-semibold text-gray-900">{{ assignment.deadline|date:"M d, Y" }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Grading Form -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-edit mr-2 text-primary-500"></i>
                    Assessment Form
                </h3>
                
                <form method="POST" id="gradingForm" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Grade Input -->
                    <div>
                        <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-graduation-cap mr-1"></i>
                            Grade
                        </label>
                        <div class="flex space-x-2 mb-3">
                            {% for grade in 'A,B+,B,C+,C,D,E,F'|split:',' %}
                            <button type="button" 
                                    onclick="setGrade('{{ grade }}')"
                                    class="flex-1 py-2 text-center text-sm font-medium border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 grade-btn"
                                    data-grade="{{ grade }}">
                                {{ grade }}
                            </button>
                            {% endfor %}
                        </div>
                        <input type="text" 
                               name="grade" 
                               id="grade"
                               value="{% if assignment.grade %}{{ assignment.grade }}{% endif %}"
                               class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 focus:outline-none transition-colors"
                               placeholder="Enter grade (A, B+, 85, etc.)"
                               required>
                        <p class="mt-2 text-sm text-gray-500">Enter a letter grade or numerical score</p>
                    </div>
                    
                    <!-- Score Input -->
                    <div>
                        <label for="score" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-percentage mr-1"></i>
                            Score (Optional)
                        </label>
                        <div class="flex items-center">
                            <input type="number" 
                                   name="score" 
                                   id="score"
                                   value="{% if assignment.score %}{{ assignment.score }}{% endif %}"
                                   min="0" 
                                   max="100" 
                                   step="0.5"
                                   class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 focus:outline-none transition-colors"
                                   placeholder="e.g., 85.5">
                            <span class="ml-3 text-gray-500">/ 100</span>
                        </div>
                        <p class="mt-2 text-sm text-gray-500">Numerical score out of 100 (optional)</p>
                    </div>
                    
                    <!-- Status Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-1"></i>
                            Status
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            {% for status_value, status_label in assignment_status_choices %}
                            <label class="inline-flex items-center">
                                <input type="radio" 
                                       name="status" 
                                       value="{{ status_value }}"
                                       {% if assignment.status == status_value %}checked{% endif %}
                                       class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">{{ status_label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Feedback -->
                    <div>
                        <label for="feedback" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment-medical mr-1"></i>
                            Feedback
                        </label>
                        <textarea name="feedback" 
                                  id="feedback"
                                  rows="6"
                                  class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 focus:outline-none transition-colors"
                                  placeholder="Provide constructive feedback for the student...">{% if assignment.feedback %}{{ assignment.feedback }}{% endif %}</textarea>
                        <div class="mt-2 flex justify-between items-center text-sm text-gray-500">
                            <span>
                                <i class="fas fa-user-graduate mr-1"></i>
                                Your feedback will be visible to the student
                            </span>
                            <span id="charCount">0/1000</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" 
                                id="submitBtn"
                                class="flex-1 inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white gradient-primary hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                            <i class="fas fa-check-circle mr-2"></i>
                            {% if assignment.grade %}Update Grade{% else %}Submit Grade{% endif %}
                        </button>
                        
                        <a href="{% url 'lecturer_dashboard' %}" 
                           class="flex-1 inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                            <i class="fas fa-times mr-2"></i>
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
            
            <!-- Grading Tips -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                <h3 class="text-lg font-medium text-blue-900 mb-3 flex items-center">
                    <i class="fas fa-lightbulb mr-2 text-blue-500"></i>
                    Grading Tips
                </h3>
                <ul class="space-y-2 text-sm text-blue-800">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-blue-500"></i>
                        Be specific and constructive in your feedback
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-blue-500"></i>
                        Reference the assignment rubric and learning objectives
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-blue-500"></i>
                        Highlight both strengths and areas for improvement
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-blue-500"></i>
                        Provide actionable suggestions for future assignments
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-xl p-8 max-w-sm w-full mx-4">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Submitting Grade</h3>
            <p class="text-gray-600">Please wait while we save your assessment...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Template filter for splitting string
    Handlebars.registerHelper('split', function(string, delimiter) {
        return string.split(delimiter);
    });

    // Character counter for feedback
    const feedbackTextarea = document.getElementById('feedback');
    const charCountSpan = document.getElementById('charCount');
    
    function updateCharCount() {
        const count = feedbackTextarea.value.length;
        charCountSpan.textContent = `${count}/1000`;
        
        if (count > 1000) {
            charCountSpan.classList.add('text-red-600');
            charCountSpan.classList.remove('text-gray-500');
        } else if (count > 800) {
            charCountSpan.classList.add('text-yellow-600');
            charCountSpan.classList.remove('text-gray-500', 'text-red-600');
        } else {
            charCountSpan.classList.remove('text-red-600', 'text-yellow-600');
            charCountSpan.classList.add('text-gray-500');
        }
    }
    
    if (feedbackTextarea) {
        feedbackTextarea.addEventListener('input', updateCharCount);
        // Initial count
        updateCharCount();
    }
    
    // Grade button selection
    function setGrade(grade) {
        document.getElementById('grade').value = grade;
        
        // Update button states
        document.querySelectorAll('.grade-btn').forEach(btn => {
            if (btn.dataset.grade === grade) {
                btn.classList.add('bg-primary-100', 'border-primary-500', 'text-primary-700');
                btn.classList.remove('border-gray-300', 'hover:bg-gray-50');
            } else {
                btn.classList.remove('bg-primary-100', 'border-primary-500', 'text-primary-700');
                btn.classList.add('border-gray-300', 'hover:bg-gray-50');
            }
        });
        
        // Auto-set score based on grade (optional)
        const gradeScores = {
            'A': 90, 'B+': 85, 'B': 80, 'C+': 75, 'C': 70, 
            'D': 65, 'E': 55, 'F': 45
        };
        
        if (gradeScores[grade]) {
            const scoreInput = document.getElementById('score');
            if (!scoreInput.value) {
                scoreInput.value = gradeScores[grade];
            }
        }
    }
    
    // Initialize grade buttons
    document.addEventListener('DOMContentLoaded', function() {
        const currentGrade = document.getElementById('grade').value;
        if (currentGrade) {
            setGrade(currentGrade);
        }
        
        // Auto-focus feedback if grade exists
        if (currentGrade && feedbackTextarea) {
            feedbackTextarea.focus();
        }
        
        // Format grade input
        const gradeInput = document.getElementById('grade');
        gradeInput.addEventListener('blur', function() {
            this.value = this.value.toUpperCase().trim();
        });
    });
    
    // Form validation
    const gradingForm = document.getElementById('gradingForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingModal = document.getElementById('loadingModal');
    
    gradingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const gradeInput = document.getElementById('grade');
        const grade = gradeInput.value.trim();
        
        if (!grade) {
            showError(gradeInput, 'Please enter a grade');
            return;
        }
        
        // Validate grade format
        const gradePattern = /^[A-F][+-]?$|^\d{1,3}(\.\d{1,2})?$|^\d{1,3}\/\d{1,3}$/i;
        if (!gradePattern.test(grade.toUpperCase())) {
            showError(gradeInput, 'Please enter a valid grade format (e.g., A, B+, 85, 85.5, 85/100)');
            return;
        }
        
        // Validate score if provided
        const scoreInput = document.getElementById('score');
        if (scoreInput.value) {
            const score = parseFloat(scoreInput.value);
            if (isNaN(score) || score < 0 || score > 100) {
                showError(scoreInput, 'Score must be between 0 and 100');
                return;
            }
        }
        
        // Show loading modal
        loadingModal.classList.remove('hidden');
        submitBtn.disabled = true;
        
        // Submit form
        setTimeout(() => {
            gradingForm.submit();
        }, 1000);
    });
    
    function showError(element, message) {
        // Remove existing error
        const existingError = element.parentNode.querySelector('.error-message');
        if (existingError) existingError.remove();
        
        // Add error styling
        element.classList.add('border-red-500', 'bg-red-50');
        
        // Create error message
        const errorDiv = document.createElement('p');
        errorDiv.className = 'error-message mt-2 text-sm text-red-600 flex items-center';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-circle mr-2"></i>
            ${message}
        `;
        
        element.parentNode.appendChild(errorDiv);
        
        // Focus on the input
        element.focus();
        
        // Remove error styling on input
        element.addEventListener('input', function() {
            this.classList.remove('border-red-500', 'bg-red-50');
            errorDiv.remove();
        });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter to submit
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            if (!submitBtn.disabled) {
                gradingForm.dispatchEvent(new Event('submit'));
            }
        }
        
        // Escape to cancel
        if (e.key === 'Escape') {
            window.location.href = "{% url 'lecturer_dashboard' %}";
        }
        
        // Number keys for quick grades
        if (e.altKey && e.key >= '1' && e.key <= '8') {
            const grades = ['A', 'B+', 'B', 'C+', 'C', 'D', 'E', 'F'];
            const index = parseInt(e.key) - 1;
            if (grades[index]) {
                setGrade(grades[index]);
            }
        }
    });
    
    // Auto-calculate score from grade
    document.getElementById('grade').addEventListener('change', function() {
        const grade = this.value.toUpperCase();
        const scoreInput = document.getElementById('score');
        
        // Only auto-fill if score is empty
        if (!scoreInput.value) {
            const gradeScores = {
                'A': 90, 'A+': 95, 'A-': 87,
                'B': 80, 'B+': 85, 'B-': 77,
                'C': 70, 'C+': 75, 'C-': 67,
                'D': 60, 'D+': 65, 'D-': 57,
                'F': 45
            };
            
            if (gradeScores[grade]) {
                scoreInput.value = gradeScores[grade];
            }
        }
    });
    
    // Prevent leaving page during submission
    window.addEventListener('beforeunload', function(e) {
        if (submitBtn.disabled) {
            e.preventDefault();
            e.returnValue = 'Your grading changes have not been saved. Are you sure you want to leave?';
        }
    });
    
    // Auto-save draft (optional feature)
    let draftTimeout;
    function saveDraft() {
        const formData = {
            grade: document.getElementById('grade').value,
            score: document.getElementById('score').value,
            feedback: document.getElementById('feedback').value,
            status: document.querySelector('input[name="status"]:checked')?.value
        };
        
        localStorage.setItem('grade_draft', JSON.stringify(formData));
        showNotification('Draft saved locally', 'info', 2000);
    }
    
    // Auto-save every 30 seconds
    ['input', 'change'].forEach(event => {
        gradingForm.addEventListener(event, function() {
            clearTimeout(draftTimeout);
            draftTimeout = setTimeout(saveDraft, 30000);
        });
    });
    
    // Load draft on page load
    document.addEventListener('DOMContentLoaded', function() {
        const draft = localStorage.getItem('grade_draft');
        if (draft) {
            try {
                const data = JSON.parse(draft);
                if (confirm('Would you like to restore your last draft?')) {
                    document.getElementById('grade').value = data.grade || '';
                    document.getElementById('score').value = data.score || '';
                    document.getElementById('feedback').value = data.feedback || '';
                    
                    if (data.grade) {
                        setGrade(data.grade);
                    }
                    
                    if (data.status) {
                        document.querySelector(`input[name="status"][value="${data.status}"]`).checked = true;
                    }
                    
                    updateCharCount();
                }
            } catch (e) {
                console.error('Failed to parse draft:', e);
            }
        }
        
        // Clear draft on successful submission
        localStorage.removeItem('grade_draft');
    });
</script>
{% endblock %}
